\documentclass[10.9pt]{article}
\newcommand\tab[1][0.5cm]{\hspace*{#1}}
\usepackage[utf8]{inputenc}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{color}
\pagenumbering{gobble}
\usepackage{changepage}
\usepackage{titletoc}
\usepackage{titlesec}
\usepackage{multicol}
\usepackage{graphicx}

\usepackage{makecell}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\hypersetup{
	colorlinks,
	citecolor=black,
	filecolor=black,
	linkcolor=black,
	urlcolor=black
}

\lstdefinestyle{mystyle}{
	backgroundcolor=\color{backcolour},   
	commentstyle=\color{codegreen},
	keywordstyle=\color{magenta},
	numberstyle=\tiny\color{codegray},
	stringstyle=\color{codepurple},
	basicstyle=\footnotesize\ttfamily,
	breakatwhitespace=false,         
	breaklines=true,                 
	captionpos=b,                    
	keepspaces=true,                 
	numbers=left,                    
	numbersep=5pt,                  
	showspaces=false,                
	showstringspaces=false,
	showtabs=false,                  
	tabsize=2
}

\lstset{basicstyle=\tiny,style=mystyle}

\newcommand{\titledate}[2][2.5in]{%
	\noindent%
	\begin{tabular}{@{}p{#1}@{}}
		\\ \hline \\[-.75\normalbaselineskip]
		#2
	\end{tabular} \hspace{1in}
	\begin{tabular}{@{}p{#1}@{}}
		\\ \hline \\[-.75\normalbaselineskip]
		Date
	\end{tabular}
}

\titleformat{\section}{\normalfont\Large\bfseries}{}{0pt}{}

% for forcing tables to fit
\usepackage{changepage}

\begin{document}
	

\begin{titlepage}
	
\author{Eric Pereira}
\date{Septemer 24\textsuperscript{th}, 2019}
\title{CSE4501 -- Vulnerability Research:\\Lab 5}

\maketitle

\end{titlepage}

\titlecontents{section}[0em]
{\vskip 0.5ex}%
{\scshape}% numbered sections formattin
{\itshape}% unnumbered sections formatting
{}%

\tableofcontents

\newpage \pagenumbering{arabic}

This lab involves utilizing an ASLR defeat to redirect execution to code of our choosing. Lab is worth 30 pts

to build the lab executable, simply execute:
\begin{lstlisting}[language=bash]
	$  make
\end{lstlisting}
This will produce an executable named \texttt{aslr\_lab}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                %
%                                   Part 1                                       %
%                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Part 1 - Demonstrate EIP control 10pts}
\tab The basic vulnerability we are exploiting is an out of bounds array access. In \texttt{main()} an array of struct record objects are allocated on the stack. A pointer to this array is passed to several functions that prompt the user to enter a record to access. For example, in \texttt{save\_record()} we see.
\begin{lstlisting}[language=C]
	printf("Which record do you want to save to?\n");
	uint32_t recordnum = read_u32();
	struct record *r = &records[recordnum];
\end{lstlisting}
\tab We then store user provided input to a potentially invalid array member. In \texttt{main()}, note that a function pointer is created on the stack, which points to \texttt{lose()}. Your goal for this part is to overwrite the function pointer with some arbitrary value, such as \texttt{0x41414141} and cause the program to execute it.
\textbf{\\Solution:\\} 
\tab 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                %
%                                   Problem 2                                    %
%                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Part 2 - Exploit Without ASLR 10pts}
\tab Once you ensure we have EIP control, the next step involves executing the \texttt{win()} function. We will first do this with ASLR disabled. First make sure that ASLR is disabled on your machine. To check, run the following command in the aslr\_lab directory
\begin{lstlisting}[language=bash]
	$  ./set_aslr
	ASLR value is currently:
	0
\end{lstlisting}
\tab If this does not show 0, run
\begin{lstlisting}[language=bash]
	$  sudo ./set_aslr 0
\end{lstlisting}
\tab This should disable ASLR.

\tab Now, determine the load address of the \texttt{win()} (via gdb, IDA Pro, etc.) function and exploit the out of bounds access vulnerability to execute it.

\textbf{\\Solution:\\}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                %
%                                   Part 3                                       %
%                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Part 3 - Exploit with ASLR 10pts }
\tab Now that you know you can execute \texttt{win()}, turn on ASLR
\begin{lstlisting}[language=bash]
	$  sudo ./set_aslr 2
\end{lstlisting}
\tab This should enable ASLR.

\tab Try exploiting the vulnerability with the base address of \texttt{win()} that you discovered in Part 2. This will most likely cause a segmentation fault. This is due to the address of \texttt{win()} being randomized by ASLR. Your goal for this lab is to execute \texttt{win()} with ASLR on. To do this, you will have to utilize the out of bounds access vulnerability to leak information that will allow you to determine where \texttt{win()} is located, then use the out of bounds access to exploit the vulnerability to gain code execution.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                %
%                            Going Further                                       %
%                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Going Further}
\tab As an exercise for the reader, and your own edification, see if you can leverage the vulnerability to gain complete arbitrary code execution, either via shellcode or ROP. Is it possible? We don’t know, that’s your job! But if you succeed, you get 1337 hax0r points and the satisfaction of a job well done.

\end{document}
